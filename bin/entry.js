#!/usr/bin/env node
const path = require('path');
const fs = require('fs');
const endOfLine = require('os').EOL;
const ora = require('ora');
const stripIndent = require('common-tags').stripIndent;
const chalk = require('chalk');

const Components = require('../components/components');

const entryFile = path.resolve('./components/', 'index.js');
const entryStream = fs.createWriteStream(entryFile);
let importTemplate = '';
let keyTemplate = '';
let KeyExport = '';

Object.keys(Components).forEach((key, index, array) => {
  const lastLine = index === array.length - 1 ? '' : endOfLine;
  const comma = index === array.length - 1 ? '' : ',';

  importTemplate +=
    (key.startsWith('...')
      ? `import * as ${key.slice(3)} from '${Components[key]}';`
      : `import ${key} from '${Components[key]}';`) + lastLine;
  keyTemplate += '  ' + key + comma + lastLine;
  KeyExport +=
    '  ' + (key.startsWith('...') ? key.slice(3) : key) + comma + lastLine;
});

const entry = stripIndent(`
/* Automatically generated by build/gen.js*/
import '@babel/polyfill';
import device from './_util/device';
import directives from './_directive';
${importTemplate}

const components = {
${keyTemplate}
};

const WooUI = {
  install(Vue, options = {}) {
    device.init(options.device);
    Object.keys(components).forEach(key => {
      Vue.component(components[key].name, components[key]);
    });
    Vue.prototype.$_wooBus = Vue.$_wooBus = new Vue();

    const modalList = {
      $_w_toast: 'Toast',
      $_w_dialog: 'Dialog'
    };

    Object.keys(modalList).forEach(key => {
      if (options.modalsRegister) {
        const i = modalList[key];
        const Modal = Vue.extend(components[i]);
        const vm = new Modal();
        document.body.appendChild(vm.$mount().$el);
      }
      const action = modalList[key];
      const wooAction = \`woo\${action}\`;
      Vue.prototype[key] = data => Vue.$_wooBus.$emit(wooAction, data);
      Vue.prototype[key + 'Close'] = data =>
        Vue.$_wooBus.$emit(wooAction + 'Close', data);
    });
    Vue.use(directives);
  }
};

WooUI.version = process.env.PACKAGE_VERSION;
WooUI.name = process.env.PACKAGE_NAME;

// prettier-ignore
export {
  WooUI as default,
${KeyExport}
};

if (typeof window !== 'undefined' && window.Vue) {
  window.Vue.use(WooUI);
}
`);

const spinner = ora('Start building entry...');

spinner.start();

entryStream.write(entry, 'utf8', function(err) {
  if (err) {
    spinner.fail(err);
  }
  spinner.succeed(chalk.green('Entry builded successfully'));
  console.log(
    chalk.keyword('orange')(`✏️ './components/index.js' has been writen`)
  );
});

entryStream.end(endOfLine);
